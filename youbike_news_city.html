<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>YouBike 自動輿情監測（依縣市分類）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    h1 { margin-top: 0; font-size: 24px; }
    .toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
    button { padding: 6px 12px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; background: #fff; }
    button:disabled { opacity: 0.6; cursor: default; }
    #status { font-size: 14px; color: #555; }
    .city-section { margin-top: 18px; padding: 12px 14px 14px; background: #ffffff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .city-section h2 { margin: 0 0 8px; font-size: 18px; border-left: 4px solid #333; padding-left: 6px; }
    .city-section ul { list-style: none; padding-left: 0; margin: 0; }
    .city-section li { margin-bottom: 8px; }
    .city-section a { text-decoration: none; color: #0056b3; font-weight: 600; }
    .city-section a:hover { text-decoration: underline; }
    .meta { font-size: 12px; color: #777; margin-top: 2px; }
    .empty { margin-top: 20px; color: #777; font-size: 14px; }
  </style>
</head>
<body>
  <h1>YouBike 自動輿情監測（依縣市分類）</h1>
  <div class="toolbar">
    <button id="refreshBtn">立即更新</button>
    <span id="status">尚未更新</span>
  </div>
  <div id="citySections"></div>
  <p class="empty" id="emptyMsg" style="display:none;">
    目前找不到包含「YouBike」關鍵字的新聞標題，或標題中沒有任何縣市關鍵字。
  </p>

  <script>
    const RSS_URL =
      "https://news.google.com/rss/search?q=YouBike&hl=zh-TW&gl=TW&ceid=TW:zh-Hant";
    const RSS2JSON_API =
      "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(RSS_URL);

    const CITY_RULES = [
      { key: "taipei",   name: "台北市", keywords: ["台北", "臺北", "北市"] },
      { key: "new_taipei", name: "新北市", keywords: ["新北"] },
      { key: "taoyuan",  name: "桃園市", keywords: ["桃園"] },
      { key: "hsinchu",  name: "新竹市 / 新竹縣", keywords: ["新竹"] },
      { key: "miaoli",   name: "苗栗縣", keywords: ["苗栗"] },
      { key: "taichung", name: "台中市", keywords: ["台中", "臺中"] },
      { key: "changhua", name: "彰化縣", keywords: ["彰化"] },
      { key: "nantou",   name: "南投縣", keywords: ["南投"] },
      { key: "yunlin",   name: "雲林縣", keywords: ["雲林"] },
      { key: "chiayi",   name: "嘉義市 / 嘉義縣", keywords: ["嘉義"] },
      { key: "tainan",   name: "台南市", keywords: ["台南", "臺南"] },
      { key: "kaohsiung",name: "高雄市", keywords: ["高雄"] },
      { key: "pingtung", name: "屏東縣", keywords: ["屏東"] },
      { key: "yilan",    name: "宜蘭縣", keywords: ["宜蘭"] },
      { key: "hualien",  name: "花蓮縣", keywords: ["花蓮"] },
      { key: "taitung",  name: "台東縣", keywords: ["台東", "臺東"] },
      { key: "penghu",   name: "澎湖縣", keywords: ["澎湖"] },
      { key: "kinmen",   name: "金門縣", keywords: ["金門"] },
      { key: "lienchiang", name: "連江縣 / 馬祖", keywords: ["連江", "馬祖"] }
    ];

    const OTHER_KEY = "other";
    const OTHER_NAME = "未明確標示縣市 / 其他";

    const refreshBtn = document.getElementById("refreshBtn");
    const statusSpan = document.getElementById("status");
    const citySections = document.getElementById("citySections");
    const emptyMsg = document.getElementById("emptyMsg");

    function formatTime(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleString("zh-TW", { timeZone: "Asia/Taipei" });
    }

    function detectCityKey(text) {
      const lower = text.toLowerCase();
      for (const rule of CITY_RULES) {
        for (const kw of rule.keywords) {
          if (lower.includes(kw.toLowerCase())) return rule.key;
        }
      }
      return OTHER_KEY;
    }

    function renderNewsByCity(items, feedTitle) {
      citySections.innerHTML = "";
      const buckets = {};
      for (const rule of CITY_RULES) buckets[rule.key] = [];
      buckets[OTHER_KEY] = [];

      for (const item of items) {
        const combinedText = (item.title || "") + " " + (item.description || "");
        const cityKey = detectCityKey(combinedText);
        buckets[cityKey].push(item);
      }

      let totalCount = 0;

      for (const rule of CITY_RULES) {
        const list = buckets[rule.key];
        if (!list.length) continue;
        totalCount += list.length;

        const section = document.createElement("div");
        section.className = "city-section";

        const h2 = document.createElement("h2");
        h2.textContent = `${rule.name}（${list.length} 則）`;
        section.appendChild(h2);

        const ul = document.createElement("ul");

        for (const item of list) {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = item.link;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = item.title;

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `${feedTitle}｜${formatTime(item.pubDate)}`;

          li.appendChild(a);
          li.appendChild(meta);
          ul.appendChild(li);
        }

        section.appendChild(ul);
        citySections.appendChild(section);
      }

      const otherList = buckets[OTHER_KEY];
      if (otherList.length) {
        totalCount += otherList.length;

        const section = document.createElement("div");
        section.className = "city-section";

        const h2 = document.createElement("h2");
        h2.textContent = `${OTHER_NAME}（${otherList.length} 則）`;
        section.appendChild(h2);

        const ul = document.createElement("ul");

        for (const item of otherList) {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = item.link;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = item.title;

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `${feedTitle}｜${formatTime(item.pubDate)}`;

          li.appendChild(a);
          li.appendChild(meta);
          ul.appendChild(li);
        }

        section.appendChild(ul);
        citySections.appendChild(section);
      }

      if (!totalCount) emptyMsg.style.display = "block";
      else emptyMsg.style.display = "none";
    }

    async function fetchNews() {
      try {
        refreshBtn.disabled = true;
        statusSpan.textContent = "更新中…";
        citySections.innerHTML = "";
        emptyMsg.style.display = "none";

        const res = await fetch(RSS2JSON_API);
        const data = await res.json();

        let items = data.items || [];
        const feedTitle = data.feed?.title || "";
        items = items.filter((item) => /youbike/i.test(item.title));

        if (!items.length) emptyMsg.style.display = "block";
        else renderNewsByCity(items, feedTitle);

        statusSpan.textContent =
          "最後更新時間：" +
          new Date().toLocaleString("zh-TW", { timeZone: "Asia/Taipei" });
      } catch (err) {
        statusSpan.textContent = "更新失敗：" + err.message;
        emptyMsg.style.display = "block";
      } finally {
        refreshBtn.disabled = false;
      }
    }

    refreshBtn.addEventListener("click", fetchNews);
    fetchNews();
    setInterval(fetchNews, 10 * 60 * 1000);
  </script>
</body>
</html>
